<?xml version="1.0" encoding="UTF-8"?>
<h:html xmlns:h="http://www.w3.org/1999/xhtml" 
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms" 
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:ev="http://www.w3.org/2001/xml-events" 
    xmlns:xl="http://www.w3.org/1999/xlink"
    xmlns:xs="http://www.w3.org/2001/XMLSchema" 
    xmlns:m="http://www.music-encoding.org/ns/mei"
    xmlns:t="http://www.tei-c.org/ns/1.0" 
    xmlns:dcm="http://www.kb.dk/dcm">
    
    <!--
        Source data editor 
        Danish Centre for Music Publication (DCM) 
        Axel Teich Geertinger, 2012
        atge@kb.dk
    -->
    
    <h:head>
        
        <h:title id="PageTitle">MerMEId - Editing source metadata</h:title>
        
        <h:meta http-equiv="Content-Type" content="application/xhtml+xml"/>
        
        <h:script type="text/javascript" src="http:/editor/js/editor.js"/>
        
        <h:style type="text/css" media="all"> 
            @import "/editor/style/tab_style.css"; 
            @import "/editor/style/xform_style.css";
            @import "/editor/style/model_editor_style.css";
        </h:style>
        
        <xi:include href="details-form-model.xml" parse="xml"/>
        
        <!-- XBL components -->
        <xi:include href="includes/element_buttons.xbl" parse="xml"/>
        <xi:include href="includes/element_buttons_typed.xbl" parse="xml"/>
        <xi:include href="includes/delete_parent_with_last.xbl" parse="xml"/>
        <xi:include href="includes/create.xbl" parse="xml"/>
        <xi:include href="includes/dropdown_month_date.xbl" parse="xml"/>
        <xi:include href="includes/date_editor.xbl" parse="xml"/>
        <xi:include href="includes/relator.xbl" parse="xml"/>
        <xi:include href="includes/item.xbl" parse="xml"/>
        <xi:include href="includes/id.xbl" parse="xml"/>
        <xi:include href="includes/attribute_editor.xbl" parse="xml"/>
    </h:head>
    
    <h:body class="source" onload="initialize();">
        
        <xf:group id="form-group">
            
            <xi:include href="edit-form-event-handlers.xml" parse="xml"/>
            <xxf:variable name="uri" 
                select="concat(instance('parameters')/dcm:orbeon_dir,
                '?uri=',
                instance('parameters')/dcm:form_home,
                'edit-source-case.xml&amp;doc=',
                instance('parameters')/dcm:xml_file)"/>
            
            <h:div class="inputdiv">
                
                <xf:group id="editing_status"
                    ref="instance('data-instance')/m:meiHead/m:workDesc/m:work/m:titleStmt/m:title[normalize-space(.)][1]">
                    <xf:output value="concat(substring(.,1,80), instance('temp')/etc[string-length(instance('data-instance')/m:meiHead/m:workDesc/m:work/m:titleStmt/m:title[1])&gt;80], instance('temp')[changed='true']/change_marker)" id="work_identifier">
                        <xf:label/> 
                        <xf:action ev:event="xforms-value-changed">
                            <xf:load resource="javascript:setPageTitle()"/>
                        </xf:action>
                    </xf:output>
                </xf:group>
                
                <h:div style="float:right">
                    <xf:submit submission="save-to-file">
                        <xf:label><h:img src="http:/editor/images/save_small.png" alt="Save"/> Save</xf:label>
                    </xf:submit>
                    <xf:submit submission="save-to-file">
                        <xf:label><h:img src="http:/editor/images/save_and_close.png" alt="Save and close"/> Save &amp; close</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:load resource="{$uri}" show="replace"/>
                        </xf:action>
                    </xf:submit>
                    <xf:trigger>
                        <xf:label><h:img src="http:/editor/images/close.gif" alt="Cancel (close)"/> Cancel</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:load resource="{$uri}" show="replace"/>
                        </xf:action>
                    </xf:trigger>
                </h:div>
                     
                <xf:group ref="instance('data-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source[@xml:id=instance('temp')/id]">
                    <h:h3>
                        <xf:output value="m:titleStmt/m:title"/>
                        <xf:group ref=".[normalize-space(m:titleStmt/m:title)='']"> [No description] </xf:group>
                        <dcm:id ref="."/>
                        <dcm:attribute-editor ref="."/>
                    </h:h3>                
                    
                    <h:fieldset>
                        <h:legend>Source 
                            <h:a class="help">?<h:span class="comment">A source corresponds to the FRBR "manifestation" level. At this level, therefore, 
                                only information common to all copies of this source should be entered. <h:br/>
                                Information about individual copies (including their location) should be given at "Item" level below.</h:span></h:a>
                        </h:legend>
                        <h:div class="vertical_spacer"> </h:div>
                        
                        <dcm:create 
                            nodeset="m:titleStmt"
                            label="Add title"
                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:titleStmt"/>
                        <xf:input ref="m:titleStmt/m:title" class="maxlong">
                            <xf:label class="fixed_width_long">Short description or title <h:a class="help">?<h:span class="comment">A heading identifying the source, e.g. "Printed score, first
                                edition", "Autograph score, draft" or "Source A"</h:span></h:a>
                            </xf:label>
                        </xf:input>
                        <dcm:id ref="m:titleStmt/m:title"/>
                        <dcm:attribute-editor ref="m:titleStmt/m:title"/>
                        
                        <!-- Point to relevant version if more than one available -->
                        <xf:group ref=".[count(instance('data-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression)&gt;1]">
                            <h:div class="vertical_spacer"/>
                            <h:div>
                                <dcm:create 
                                    nodeset="m:titleStmt"
                                    label="Specify work version"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:relationList/m:relation[@rel='isEmbodimentOf'][1]"/>
                                <xf:select1 ref="m:relationList/m:relation[@rel='isEmbodimentOf'][1]" xxf:refresh-items="true" id="cast-select" class="maxlong">
                                    <xf:label class="fixed_width_long">Represents: 
                                        <h:a class="help">?<h:span class="comment">Indicates which version of the work 
                                            is embodied by the source</h:span></h:a>
                                    </xf:label>
                                    <xf:item>
                                        <xf:label>- Please select -</xf:label>
                                        <xf:value/>
                                    </xf:item>
                                    <xf:itemset nodeset="instance('data-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression">
                                        <xf:label><xf:output value="m:titleStmt/m:title"/> (ID: <xf:output value="@xml:id"/>)</xf:label>
                                        <xf:value ref="@xml:id"></xf:value>
                                    </xf:itemset>
                                </xf:select1>	
                                <dcm:attribute-editor ref="m:relationList/m:relation[@rel='isEmbodimentOf'][1]"/>
                            </h:div>
                        </xf:group>
                        
                        <!-- Source classification -->
                        <!-- For now, editing classification requires either the DCM classcodes being defined already 
                        in <work> or that a termList exists already -->
                        <xf:group ref=".[m:classification/m:termList or //m:work/m:classification/m:classCode[@xml:id='DcmContentClass']]">
                            <h:fieldset>
                                <h:legend>Classification
                                    <xf:trigger appearance="minimal" ref="m:classification[//m:work/m:classification/m:classCode[@xml:id='DcmContentClass']]">
                                        <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete"/></xf:label>
                                        <xf:action ev:event="DOMActivate">
                                            <xf:delete nodeset="."/>
                                        </xf:action>
                                    </xf:trigger>
                                    <dcm:attribute-editor ref="m:classification/m:termList"/>
                                </h:legend>
                                <h:div class="vertical_spacer"> </h:div>
                                <h:div class="vertical_spacer"> </h:div>
                                <xf:group ref=".[//m:work/m:classification/m:classCode[@xml:id='DcmContentClass']]">
                                    <dcm:create 
                                        nodeset="m:classification"
                                        label="Add source classification"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:classification"/>
                                    <dcm:create ref="m:classification"
                                        nodeset="m:termList"
                                        label="Add source classification"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:classification/m:termList"/>
                                </xf:group>
                                <xf:group ref="m:classification/m:termList[m:term[contains(@classcode,'Dcm')]]">
                                    <xf:select1 ref="m:term[@classcode='DcmContentClass']">
                                        <xf:label class="fixed_width">Content</xf:label>
                                        <xf:item>
                                            <xf:value/>
                                            <xf:label> </xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>music</xf:value>
                                            <xf:label>Music</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>text</xf:value>
                                            <xf:label>Text</xf:label>
                                        </xf:item>
                                    </xf:select1>
                                    <dcm:attribute-editor ref="m:term[@classcode='DcmContentClass']"/>
                                    <h:br clear="both"/>
                                    <xf:select1 ref="m:term[@classcode='DcmPresentationClass']">
                                        <xf:label class="fixed_width">Presentation <h:a class="help">?<h:span class="comment">Describes
                                            the source's basic mode of production (manuscript or print). <br/> "Print, specific copy" refers to a 
                                            specific copy of a printed source, e.g. the composer's own copy.</h:span></h:a></xf:label>
                                        <xf:item>
                                            <xf:value/>
                                            <xf:label> </xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>manuscript</xf:value>
                                            <xf:label>Manuscript</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>print</xf:value>
                                            <xf:label>Print</xf:label>
                                        </xf:item>
                                    </xf:select1>
                                    <dcm:attribute-editor ref="m:term[@classcode='DcmPresentationClass']"/>
                                    <h:br clear="both"/>
                                    <xf:select1 ref="m:term[@classcode='DcmAuthorityClass']">
                                        <xf:label class="fixed_width">Authority <h:a class="help">?<h:span class="comment">For 
                                            use with manuscript sources. Describes the composer's degree of involvement
                                            in the production of the source. Thus, an arranger's
                                            own manuscript would <u>not</u> be classified an autograph.</h:span></h:a>
                                        </xf:label>
                                        <xf:item>
                                            <xf:value></xf:value>
                                            <xf:label> </xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>autograph</xf:value>
                                            <xf:label>Autograph</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>doubtful autograph</xf:value>
                                            <xf:label>Doubtful autograph</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>partly autograph</xf:value>
                                            <xf:label>Partly autograph</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>copy</xf:value>
                                            <xf:label>Copy</xf:label>
                                        </xf:item>
                                    </xf:select1>
                                    <dcm:attribute-editor ref="m:term[@classcode='DcmAuthorityClass']"/>
                                    <h:br clear="both"/>                        
                                    <xf:select1 ref="m:term[@classcode='DcmScoringClass']">
                                        <xf:label class="fixed_width">Scoring</xf:label>
                                        <xf:item>
                                            <xf:value></xf:value>
                                            <xf:label> </xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>score</xf:value>
                                            <xf:label>Score</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>short score</xf:value>
                                            <xf:label>Short score</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>vocal score</xf:value>
                                            <xf:label>Vocal score</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>piano score</xf:value>
                                            <xf:label>Piano score</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>parts</xf:value>
                                            <xf:label>Parts</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>score and parts</xf:value>
                                            <xf:label>Score and parts</xf:label>
                                        </xf:item>
                                    </xf:select1>
                                    <dcm:attribute-editor ref="m:term[@classcode='DcmScoringClass']"/>
                                    <h:br clear="both"/>
                                    <xf:select1 ref="m:term[@classcode='DcmStateClass']">
                                        <xf:label class="fixed_width">State</xf:label>
                                        <xf:item>
                                            <xf:value></xf:value>
                                            <xf:label> </xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>sketch</xf:value>
                                            <xf:label>Sketch</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>draft</xf:value>
                                            <xf:label>Draft</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>fair copy</xf:value>
                                            <xf:label>Fair copy</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>printer's copy</xf:value>
                                            <xf:label>Printer's copy</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>first edition</xf:value>
                                            <xf:label>First edition</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>later edition</xf:value>
                                            <xf:label>Later edition</xf:label>
                                        </xf:item>
                                    </xf:select1>
                                    <dcm:attribute-editor ref="m:term[@classcode='DcmStateClass']"/>
                                    <h:br clear="both"/>
                                    <xf:select1 ref="m:term[@classcode='DcmCompletenessClass']">
                                        <xf:label class="fixed_width">Completeness <h:a class="help">?<h:span class="comment">Describes 
                                            the completeness of the source: "Complete" indicates that this source is complete (this would also be true
                                            with a single solo violin part from an orchestral work, if it is not the remainder of an originally larger 
                                            set of parts).<br/>
                                            "Incomplete" indicates that one or more parts are missing from a set of parts.<br/>
                                            "Excerpt" designates a section of a work, published or copied for stand-alone performance 
                                            (like "Hanedansen" from Nielsen's "Maskarade").<br/>
                                            "Fragment(s)" indicates that portions of the music are missing, e.g. a fragmentary sketch or a source 
                                            from which pages are lost. 
                                        </h:span></h:a>
                                        </xf:label>
                                        <xf:item>
                                            <xf:value></xf:value>
                                            <xf:label> </xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>complete</xf:value>
                                            <xf:label>Complete</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>incomplete</xf:value>
                                            <xf:label>Incomplete</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>excerpt</xf:value>
                                            <xf:label>Excerpt</xf:label>
                                        </xf:item>
                                        <xf:item>
                                            <xf:value>fragment</xf:value>
                                            <xf:label>Fragment(s)</xf:label>
                                        </xf:item>
                                    </xf:select1>
                                    <dcm:attribute-editor ref="m:term[@classcode='DcmCompletenessClass']"/>
                                </xf:group>
                                
                                <xf:group ref="m:classification/m:termList[count(m:term[contains(@classcode,'Dcm')])&gt;0]">
                                    <h:span class="blocklabel">Other classification terms</h:span>
                                </xf:group>
                                <xf:group ref="m:classification/m:termList[count(m:term[not(contains(@classcode,'Dcm'))])=0]">
                                    <dcm:create 
                                        nodeset="m:term[not(contains(@classcode,'Dcm'))]"
                                        label="Add classification term"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:classification/m:termList/m:term[not(@classcode)]"/>
                                </xf:group>
                                <xf:repeat nodeset="m:classification/m:termList/m:term[not(@classcode) or not(contains(@classcode,'Dcm'))]"
                                    id="repeat-classification-terms">
                                    <h:div>
                                        <xf:input ref=".">
                                            <xf:label>Term</xf:label>
                                        </xf:input>
                                        <dcm:element-buttons triggers="add remove"
                                            nodeset="m:term"
                                            index="repeat-classification-terms"
                                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:classification/m:termList/m:term[not(@classcode)]"/>
                                    </h:div>
                                </xf:repeat>
                            </h:fieldset>
                        </xf:group>
                        <!-- End source classification -->
                        
                        <!-- identifiers -->
                        <h:fieldset>
                            <h:legend>Identification <h:a class="help">?<h:span class="comment">Identifiers other than the repository's own shelf mark, 
                                e.g. RISM identifiers or other catalogue numbers identifying this specific item<h:br/>
                                With manuscripts, RISM identifiers should be given at 
                                item level (below).<h:br/>
                                A source's shelf mark within an archive should not be entered here; place it  
                                in the "Location" section at item level (below) instead. 
                            </h:span></h:a></h:legend>
                            <dcm:create
                                nodeset="m:identifier"
                                label="Add identifier"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:identifier"/>
                            <xf:repeat nodeset="m:identifier" id="repeat-source-identifier">
                                <xf:input ref="@analog" class="mediumshort">
                                    <xf:label class="fixed_width">List name <h:a class="help">?<h:span 
                                        class="comment">The name of the catalogue or list identifying this 
                                        specific item, e.g. "RISM"</h:span></h:a></xf:label>
                                </xf:input>
                                <xf:input ref="." class="mediumlong">
                                    <xf:label> No. <h:a class="help">?<h:span class="comment">The number 
                                        identifying this particular source in the list, e.g. "B 1234"</h:span></h:a></xf:label>
                                </xf:input>
                                <dcm:element-buttons 
                                    triggers="add remove" 
                                    nodeset="m:identifier" 
                                    index="repeat-source-identifier"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:identifier"/>
                                <dcm:id/>
                                <dcm:attribute-editor/>
                                <h:br clear="all"/>
                            </xf:repeat>
                        </h:fieldset>
                        
                        <!-- contributors -->
                        <h:fieldset>
                            <h:legend>Contributors <h:a class="help">?<h:span class="comment">Lists persons other than the composer or a scribe, 
                                contributing to the intellectual contents of this source, e.g. an arranger or editor; 
                                the composer is usually specified under "Identification" and need not be specified here.
                                Scribes are identified below under "List of hands".</h:span></h:a>
                                <dcm:attribute-editor ref="."/>
                            </h:legend>
                            <h:div class="vertical_spacer"> </h:div>
                            <dcm:create
                                nodeset="m:titleStmt"
                                label="Add persons"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:titleStmt"/>
                            <dcm:create ref="m:titleStmt"
                                nodeset="m:respStmt"
                                label="Add persons"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:titleStmt/m:respStmt"/>
                            <dcm:create ref="m:titleStmt/m:respStmt"
                                nodeset="m:persName"
                                label="Add persons"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:titleStmt/m:respStmt/m:persName"/>
                            <xf:repeat nodeset="m:titleStmt/m:respStmt/m:persName" id="repeat-source-respstmt-person">
                                <dcm:relator ref="."/>
                                <dcm:element-buttons 
                                    triggers="add" 
                                    nodeset="m:persName" 
                                    index="repeat-source-respstmt-person"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:titleStmt/m:respStmt/m:persName"/>
                                <dcm:delete-parent-with-last index="repeat-source-respstmt-person"/>
                                <dcm:id/>
                                <dcm:attribute-editor/>
                                <h:br/>
                            </xf:repeat>
                        </h:fieldset>
                        
                        <h:fieldset>
                            <h:legend>General source description  <h:a class="help">?<h:span class="comment">Text 
                                describing or introducing to the source, its history, its significance etc.<br/>
                                Information on the source's physical appearance and condition should be given in the 
                                "physical description" area below.
                            </h:span></h:a> 
                                <!--<h:a class="help_plain"><h:img src="http:/editor/images/html_markup.gif" alt="HTML markup allowed"/><h:span class="comment">HTML markup and special characters allowed</h:span></h:a></h:legend>--></h:legend>
                            <dcm:create
                                nodeset="m:notesStmt"
                                label="Add general description"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:notesStmt"/>
                            <xf:group ref="m:notesStmt">
                                <dcm:create
                                    nodeset="m:annot[@type='source_description']"
                                    label="Add general description"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:notesStmt/m:annot[@type='source_description']"/>
                                <xf:textarea ref="m:annot[@type='source_description']"/>
                                <xf:trigger appearance="minimal" ref="m:annot[@type='source_description']">
                                    <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete"/></xf:label>
                                    <xf:action ev:event="DOMActivate">
                                        <xf:delete nodeset="."/>
                                        <xf:action if="count(parent::node()/*)=0">
                                            <xf:delete nodeset="parent::node()"/>
                                        </xf:action>
                                    </xf:action>
                                </xf:trigger>
                                <dcm:id ref="m:annot[@type='source_description']"/>
                                <dcm:attribute-editor ref="m:annot[@type='source_description']"/>
                                <h:div>
                                    <h:span class="blocklabel">External source descriptions <h:a class="help">?<h:span class="comment">Links to external resources (texts) about 
                                        this particular source.</h:span></h:a>
                                    </h:span>
                                    <dcm:create
                                        nodeset="m:annot[@type='links']"
                                        label="Add external description"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:notesStmt/m:annot[@type='links']"/>
                                </h:div>
                                <xf:group ref="m:annot[@type='links']">
                                    <dcm:create
                                        nodeset="m:ptr"
                                        label="Add external description"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:notesStmt/m:annot[@type='links']/m:ptr"/>
                                    <xf:repeat nodeset="m:ptr" id="source-notesstmt-annot-repeat-extptr">
                                        <h:div>
                                            <xf:input ref="@target" class="long">
                                                <xf:label>URI <h:a class="help">?<h:span class="comment">Link to the
                                                    resource, e.g. "http://example.com/source_description.pdf"</h:span></h:a>
                                                </xf:label>
                                            </xf:input>
                                            <xf:input ref="@xl:title">
                                                <xf:label>Label <h:a class="help">?<h:span class="comment">A short, 
                                                    descriptive text which may serve
                                                    as the link text, e.g. "The Carl Nielsen Edition's source description"</h:span></h:a></xf:label>
                                            </xf:input>
                                            <dcm:element-buttons 
                                                triggers="up down add copy" 
                                                nodeset="m:ptr" 
                                                index="source-notesstmt-annot-repeat-extptr"
                                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:notesStmt/m:annot[@type='links']/m:ptr"/>
                                            <h:span class="editmenu">
                                                <xf:trigger appearance="minimal">
                                                    <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete"/></xf:label>
                                                    <xf:action ev:event="DOMActivate">
                                                        <xf:delete nodeset="."/>
                                                        <xf:action if="count(parent::node()/*)=0">
                                                            <xf:delete nodeset="parent::node()"/>
                                                            <xf:action if="count(parent::node()/parent::node()/*)=0">
                                                                <xf:delete nodeset="parent::node()/parent::node()"/>
                                                            </xf:action>
                                                        </xf:action>
                                                    </xf:action>
                                                </xf:trigger>
                                            </h:span>
                                            <dcm:id/>
                                            <dcm:attribute-editor/>
                                        </h:div>
                                    </xf:repeat>
                                </xf:group>
                            </xf:group>
                        </h:fieldset>
                            
                        <dcm:create
                            nodeset="m:physDesc"
                            label="Add physical description"
                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc"/>
                        <xf:group ref="m:physDesc">
                            <h:fieldset>
                                <h:legend>Physical description 
                                    <h:a class="help">?<h:span class="comment">Describes features shared by all copies of this source. <h:br/>
                                        For details on a specific item (a specific copy, or a manuscript), use the "Items" section below.</h:span></h:a>
                                    <dcm:attribute-editor ref="."/>
                                </h:legend>
                                <h:div class="vertical_spacer"> </h:div>
                                <dcm:create
                                    nodeset="m:extent"
                                    label="Add extent"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:extent"/>
                                <xf:repeat nodeset="m:extent" id="physdesc-extent">
                                    <h:div>
                                        <h:span class="fixed_width">Extent:</h:span>
                                        <xf:input ref=".">
                                            <xf:label>Value <h:a class="help">?<h:span class="comment">The number of pages or folios, e.g. "48", "12 + 236", "XII + 36"
                                                + VIII"</h:span></h:a></xf:label>
                                        </xf:input>
                                        <xf:input ref="@unit">
                                            <xf:label>Unit <h:a class="help">?<h:span class="comment">Usually "pages" or "folios"</h:span></h:a></xf:label>
                                        </xf:input>
                                        <dcm:element-buttons 
                                            triggers="delete" 
                                            nodeset="m:extent" 
                                            index="physdesc-extent"
                                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:extent"/>
                                        <dcm:id/>
                                        <dcm:attribute-editor/>
                                    </h:div>
                                </xf:repeat>
                                <dcm:create
                                    nodeset="m:dimensions"
                                    label="Add dimensions"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:dimensions"/>
                                <xf:repeat nodeset="m:dimensions" id="physdesc-dimensions">
                                    <h:div>
                                        <h:span class="fixed_width">Dimensions:</h:span>
                                        <xf:input ref=".">
                                            <xf:label>Value <h:a class="help">?<h:span class="comment">Numbers describing the physical dimensions of the source given as height x width, e.g.
                                                "23.5x34"</h:span></h:a></xf:label>
                                        </xf:input>
                                        <xf:input ref="@unit">
                                            <xf:label>Unit <h:a class="help">?<h:span class="comment">Unit of measurement, usually "cm"</h:span></h:a></xf:label>
                                        </xf:input>
                                        <dcm:element-buttons 
                                            triggers="delete" 
                                            nodeset="m:dimensions" 
                                            index="physdesc-dimensions"
                                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:dimensions"/>
                                        <dcm:id/>
                                        <dcm:attribute-editor/>
                                    </h:div>
                                </xf:repeat>
                                
                                <h:div>
                                    <dcm:create
                                        nodeset="m:physMedium"
                                        label="Add physical medium"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:physMedium"/>
                                    <xf:textarea ref="m:physMedium" class="mediumheight">
                                        <xf:label class="blocklabel">Physical medium <h:a class="help">?<h:span class="comment">Description of 
                                            paper, number of staves on page, printing technique etc.
                                        </h:span></h:a></xf:label>
                                    </xf:textarea>
                                    <dcm:id ref="m:physMedium"/>
                                    <dcm:attribute-editor ref="m:physMedium"/>
                                </h:div>
                                
                                <h:div>
                                    <dcm:create
                                        nodeset="m:plateNum"
                                        label="Add plate number"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:plateNum"/>
                                    <xf:input ref="m:plateNum" class="mediumlong">
                                        <xf:label class="fixed_width">Plate no. </xf:label>
                                    </xf:input>
                                    <dcm:id ref="m:plateNum"/>
                                    <dcm:attribute-editor ref="m:plateNum"/>
                                </h:div>
                                
                            </h:fieldset>

                            <h:fieldset>
                                <h:legend>Title page 
                                    <h:a class="help">?<h:span class="comment">Transcription of the source's title page. Multiple title pages
                                        may be added if necessary</h:span></h:a>
                                    <!--<h:a class="help_plain"><h:img src="http:/editor/images/html_markup.gif" alt="HTML markup allowed"/><h:span class="comment">HTML markup and special characters allowed</h:span></h:a>-->
                                </h:legend>
                                <h:div class="vertical_spacer"> </h:div>
                                <dcm:create
                                    nodeset="m:titlePage"
                                    label="Add title page"
                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:titlePage"/>
                                <xf:repeat nodeset="m:titlePage" id="physdesc-titlepage">
                                    <xf:input ref="@label">
                                        <xf:label>Label 
                                            <h:a class="help">?<h:span class="comment">Optional label overriding the default "Title page" label, 
                                                e.g. "Secondary title page" or "title page after first fly leaf". 
                                                Especially, a label should be given to if more than one title page is quoted.</h:span></h:a>
                                        </xf:label>
                                    </xf:input>
                                    <dcm:element-buttons 
                                        triggers="up down add copy remove" 
                                        nodeset="m:titlePage" 
                                        index="physdesc-titlepage"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:titlePage"/>
                                    <dcm:id/>
                                    <dcm:attribute-editor/>
                                    <h:br/>
                                    <dcm:create
                                        nodeset="m:p"
                                        label="Add transcript"
                                        origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:physDesc/m:titlePage/m:p"/>
                                    <xf:textarea ref="m:p" class="mediumheight"/>
                                    <h:hr/> 
                                </xf:repeat>
                            </h:fieldset>

                        </xf:group>
                        
                        <h:fieldset>
                            <h:legend>Publication or creation 
                                <h:a class="help">?<h:span class="comment">If the source is a manuscript, date and place of 
                                    its creation may be entered here.<h:br/>
                                    Otherwise enter publication data.
                                </h:span></h:a>
                                <dcm:attribute-editor ref="m:pubStmt"/>
                            </h:legend>
                            <h:div class="vertical_spacer"> </h:div>
                            <dcm:create
                                nodeset="m:pubStmt"
                                label="Add publication/creation data"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:pubStmt"/>
                            <dcm:create ref="m:pubStmt"
                                nodeset="m:respStmt"
                                label="Add publication/creation data"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:pubStmt/m:respStmt"/>
                            <xf:repeat nodeset="m:pubStmt" id="repeat-source-publication">
                                <h:div>
                                    <xf:input ref="m:respStmt/m:corpName" class="mediumlong">
                                        <xf:label class="fixed_width">Publisher </xf:label>
                                    </xf:input>
                                    <dcm:id ref="m:respStmt/m:corpName"/>
                                    <dcm:attribute-editor ref="m:respStmt/m:corpName"/>
                                </h:div>
                                <h:div>
                                    <xf:input ref="m:geogName" class="mediumlong">
                                        <xf:label class="fixed_width">Place </xf:label>
                                    </xf:input>
                                    <dcm:id ref="m:geogName"/>
                                    <dcm:attribute-editor ref="m:geogName"/>
                                </h:div>
                                <dcm:date-editor ref="m:date">
                                    <xf:label class="fixed_width">Date 
                                        <h:a class="help">?<h:span class="comment">This field may be used for manuscript datings also.</h:span></h:a>
                                    </xf:label>
                                </dcm:date-editor>
                            </xf:repeat>
                        </h:fieldset>
                        
                        <!-- Components -->
                        <h:fieldset class="item-components">
                            <h:legend class="item-components">Components <h:a 
                                class="help">?<h:span class="comment">Descriptions of the individual parts that 
                                constitute a composite source</h:span></h:a>
                                <dcm:id ref="m:componentGrp"/>
                                <dcm:attribute-editor ref="m:componentGrp"/>
                            </h:legend>
                            <h:div class="vertical_spacer"/> 
                            <dcm:create
                                nodeset="m:componentGrp"
                                label="Add components"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:componentGrp"/>
                            <dcm:create ref="m:componentGrp"
                                nodeset="m:item"
                                label="Add component"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:componentGrp/m:item"/>
                            <xf:group ref=".[m:componentGrp]">
                                <h:table class="component_list" cellpadding="0" cellspacing="0" border="0">
                                    <xf:repeat nodeset="m:componentGrp/m:item" id="repeat-source-component">
                                        <h:tr class="component">
                                            <h:td class="{if(position()=last()) then 'last_cell' else 'index_cell'}">
                                                <h:img src="http:/editor/images/tree-1.png" alt="component" border="0"/>
                                            </h:td>
                                            <h:td>
                                                <h:fieldset class="compact">
                                                    <h:span class="blocklabel strong">Component <dcm:id/> 
                                                        <dcm:element-buttons 
                                                            triggers="up down copy add remove" 
                                                            nodeset="m:item" 
                                                            index="repeat-source-component"
                                                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:itemList/m:item/m:componentGrp/m:item"/>
                                                        <dcm:attribute-editor/>
                                                    </h:span>
                                                    <h:div class="vertical_spacer"/>
                                                    
                                                    <xf:input ref="@label" class="short">
                                                        <xf:label>Label <h:a class="help">?<h:span 
                                                            class="comment">An optional label for this component, explaining the 
                                                            component's position in the source, e.g. "pp.3-4"</h:span></h:a>
                                                        </xf:label>
                                                    </xf:input>
                                                    <xf:input ref="m:titleStmt/m:title" class="maxlong">
                                                        <xf:label>Title <h:a class="help">?<h:span 
                                                            class="comment">The component's title, e.g. "First movement" or "Song No.1" or  if 
                                                            describing the individual parts in a set of parts  "Soprani" or "cor."</h:span></h:a>
                                                        </xf:label>
                                                    </xf:input>
                                                    <dcm:id ref="m:titleStmt/m:title"/>
                                                    <dcm:attribute-editor ref="m:titleStmt/m:title"/>
                                                    
                                                    <xf:switch>
                                                        <xf:case id="hide_component_details" selected="true()">
                                                            <xf:trigger class="detail_button">
                                                                <xf:label>Show details</xf:label>
                                                                <xf:toggle case="show_component_details" ev:event="DOMActivate"/>
                                                            </xf:trigger>
                                                        </xf:case>
                                                        
                                                        <xf:case id="show_component_details" selected="false()">
                                                            <xf:trigger class="detail_button">
                                                                <xf:label>Hide details</xf:label>
                                                                <xf:toggle case="hide_component_details" ev:event="DOMActivate"/>
                                                            </xf:trigger>	
                                                            
                                                            <h:span class="blocklabel">Description <h:a class="help">?<h:span class="comment">A more
                                                                detailed description of this component's contents.</h:span></h:a> 
                                                                <!--<h:a class="help_plain"><h:img src="http:/editor/images/html_markup.gif" alt="HTML markup allowed"/><h:span class="comment">HTML markup and special characters allowed</h:span></h:a>-->
                                                            </h:span>
                                                            <dcm:create
                                                                nodeset="m:notesStmt"
                                                                label="Add description"
                                                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:componentGrp/m:item/m:notesStmt"/>
                                                            <xf:group ref="m:notesStmt">
                                                                <dcm:create
                                                                    nodeset="m:annot"
                                                                    label="Add description"
                                                                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:componentGrp/m:item/m:notesStmt/m:annot[1]"/>
                                                                <xf:repeat nodeset="m:annot">
                                                                    <xf:textarea ref="." class="mediumheight"/>
                                                                    <dcm:attribute-editor/>
                                                                </xf:repeat>
                                                            </xf:group>
                                                            
                                                            <xf:group ref="m:physDesc">
                                                                <h:fieldset>
                                                                    <h:legend>Physical description
                                                                        <dcm:attribute-editor/>
                                                                    </h:legend>
                                                                    <xf:repeat nodeset="m:extent" id="component-physdesc-extent">
                                                                        <h:div>
                                                                            <h:span class="fixed_width">Extent:</h:span>
                                                                            <xf:input ref=".">
                                                                                <xf:label>Value <h:a class="help">?<h:span class="comment">The number of pages or folios, 
                                                                                    e.g. "48", "XII + 36" or "VIII"</h:span></h:a></xf:label>
                                                                            </xf:input>
                                                                            <xf:input ref="@unit">
                                                                                <xf:label>Unit <h:a class="help">?<h:span class="comment">Usually "pages" or "folios"</h:span></h:a></xf:label>
                                                                            </xf:input>
                                                                            <dcm:id/>
                                                                            <dcm:attribute-editor/>                                                    
                                                                        </h:div>
                                                                    </xf:repeat>
                                                                    <xf:repeat nodeset="m:dimensions" id="component-physdesc-dimensions">
                                                                        <h:div>
                                                                            <h:span class="fixed_width">Dimensions:</h:span>
                                                                            <xf:input ref=".">
                                                                                <xf:label>Value <h:a class="help">?<h:span class="comment">Numbers describing the physical dimensions 
                                                                                    of the source, usually given as height x width, e.g. "23.5x34"</h:span></h:a></xf:label>
                                                                            </xf:input>
                                                                            <xf:input ref="@unit">
                                                                                <xf:label>Unit <h:a class="help">?<h:span class="comment">Unit of measurement, usually "cm" or "inches"</h:span></h:a></xf:label>
                                                                            </xf:input>
                                                                            <dcm:id/>
                                                                            <dcm:attribute-editor ref="."/>                                                    
                                                                        </h:div>
                                                                    </xf:repeat>
                                                                    <xf:textarea ref="m:physMedium" class="mediumheight">
                                                                        <xf:label class="blocklabel">Physical medium <h:a class="help">?<h:span class="comment">Description of 
                                                                            paper, number of staves on page, printing technique etc.
                                                                        </h:span></h:a></xf:label>
                                                                    </xf:textarea>
                                                                    <dcm:id ref="m:physMedium"/>
                                                                    <dcm:attribute-editor ref="m:physMedium"/>                                                    
                                                                </h:fieldset>
                                                            </xf:group>
                                                        </xf:case>
                                                    </xf:switch>
                                                </h:fieldset>
                                            </h:td>
                                        </h:tr>
                                    </xf:repeat>
                                </h:table>
                            </xf:group>
                        </h:fieldset>
                        <!-- End components -->
                        
                        
                        <!-- Items -->
                        <h:fieldset class="items" id="items">
                            <h:legend class="items">Items
                                <h:a class="help">?<h:span class="comment">A list of individual copies of the source. 
                                    Manuscript sources will only have one such item.<h:br/>
                                    If the item consists of several components with different physical appearance, 
                                    the distinct features of each component may be specified using the item's "Components" section.<h:br/>
                                </h:span></h:a>
                                <dcm:id ref="m:itemList"/>
                                <dcm:attribute-editor ref="m:itemList"/>
                            </h:legend>
                            <h:div class="vertical_spacer"> </h:div>
                            <dcm:create
                                nodeset="m:itemList"
                                label="Add items"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:itemList"/>
                            <dcm:create ref="m:itemList"
                                nodeset="m:item"
                                label="Add item"
                                origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:itemList/m:item"/>
                            <xf:repeat nodeset="m:itemList/m:item" id="repeat-item">
                                <h:fieldset>
                                    <h:legend>Item  
                                        <dcm:element-buttons 
                                            triggers="up down copy add remove" 
                                            nodeset="m:item" 
                                            index="repeat-item"
                                            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:sourceDesc/m:source/m:itemList/m:item[1]"/>
                                        <dcm:id/>
                                        <dcm:attribute-editor/>
                                    </h:legend>
                                    <h:div class="vertical_spacer"> </h:div>
                                    <h:div class="vertical_spacer"> </h:div>
                                    <dcm:item ref="."/>
                                </h:fieldset>
                            </xf:repeat>
                        </h:fieldset>
                    </h:fieldset>
                    
                </xf:group>
                
                <xf:group ref=".[not(instance('data-instance')//m:source[@xml:id=instance('temp')/id])]">
                    <h:h3>Not found</h:h3>
                    <h:p>Did you remember to save your work before you opened the details editor?</h:p>
                    <h:p>Please click the "Cancel" button to return to the list.</h:p>
                </xf:group>
                
            </h:div>
            
        </xf:group>

        <xf:group ref=".[instance('parameters')/dcm:code_inspector='true']">
            <fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>
        </xf:group>
        <h:br clear="all"/>
        
        <xi:include href="edit-form-footer.xml" parse="xml"/>
    </h:body>
</h:html>
